<system>
	log_level warn
</system>

<source>
    @type forward
    port 24224
    bind 0.0.0.0
</source>

<filter *.efk.elasticsearch>
	@type parser
	format /^\[(?<time>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\]\[(?<log_level>\w+)\s*\]\[(?<category>(\w|\.)*)\s*\] \[(?<node_name>\w+)\]\s*(?<message>.*$)/
	key_name log
	time_format %Y-%m-%dT%H:%M:%S,%L
</filter>

<filter *.real-estate.crawler>
	@type parser
	format json
	key_name log
	format /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3})\s*(?<log_level>\w+)\s*\[(?<appName>.*)\,(?<traceId>.*)\,(?<spanId>.*)\,(?<exported>(?:false|true\b)*)\]\d*\s*(?:[---])\s* \[\s*(?<threadName>.*)\]\s(?<class>(?:\w|[.]|[-])*)\s*[:]\s*(?<message>.*$)/
    key_name log
    time_format %Y/%m/%d %H:%M:%S.%L
</filter>

<filter *.efk.kibana>
	@type parser
	format json
	key_name log
	time_key "@timestamp"
	time_format %Y-%m-%dT%H:%M:%SZ
</filter>

<match *.real-estate.crawler>
    @type elasticsearch
    logstash_format true
    host "#{ENV['ELASTICSEARCH_PORT_9200_TCP_ADDR']}" # dynamically configured to use Docker's link feature
    port 9200
    flush_interval 5s
</match>

<match *.**>
	@type copy
    <store>
     	@type elasticsearch
      	host "#{ENV['ELASTICSEARCH_PORT_9200_TCP_ADDR']}"
      	port 9200
      	logstash_format true
      	logstash_prefix fluentd
      	logstash_dateformat %Y%m%d
      	include_tag_key true
      	type_name access_log
      	tag_key @log_name
      	flush_interval 5s
    </store>

    <store>
      @type stdout
    </store>
</match>